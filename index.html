<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Customer Care AI</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:Arial,system-ui;background:#0f0f0f;color:#fff;display:grid;place-items:center;min-height:100vh}
    .wrap{width:min(980px,92vw);background:#121212;border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.6);padding:18px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{font-weight:700;font-size:20px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:#ffb020;color:#111}
    .btn.ghost{background:#2a2a2a;color:#fff}
    .pill{background:#222;border-radius:999px;padding:8px 12px;font-weight:700}
    .panel{margin-top:14px;background:#0e0e0e;border:1px solid #242424;border-radius:14px;padding:14px}
    #convoLog{height:260px;overflow:auto;background:#0b0b0b;border:1px solid #262626;border-radius:12px;padding:12px;white-space:pre-wrap}
    .hint{opacity:.8;margin-top:10px;font-size:13px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
    .row input,.row textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #2a2a2a;background:#0b0b0b;color:#fff}
    .row textarea{grid-column:1/-1;min-height:80px;resize:vertical}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Customer Care AI — Hands-Free Voice</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="btnEnable" class="btn primary">Enable Voice (1x)</button>
        <button id="btnStop" class="btn ghost">Stop</button>
        <div id="statusPill" class="pill">Status: idle</div>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:700;margin-bottom:8px">Conversation</div>
      <div id="convoLog"></div>
      <div class="hint">Goal: press Enable once → speak naturally → it auto-sends when you stop talking → replies → goes back to listening.</div>
    </div>

    <div class="panel">
      <div style="font-weight:700;margin-bottom:8px">Lead Capture (optional)</div>
      <div class="row">
        <input placeholder="First name" />
        <input placeholder="Last name" />
        <input placeholder="Email" />
        <input placeholder="Phone" />
        <textarea placeholder="Notes"></textarea>
      </div>
      <button class="btn ghost" style="margin-top:10px;width:100%">Submit</button>
    </div>
  </div>

  <script>
  /* ============================================================
     CUSTOMER CARE AI — VOICE CAPTURE FIX (ANDROID/CHROME SAFE)
     - Uses SpeechRecognition OR webkitSpeechRecognition fallback
     - Hands-free loop: listens -> emits final transcript -> keeps listening
     - Prevents duplicate starts
     ============================================================ */

  (() => {
    const $ = (sel) => document.querySelector(sel);

    const convo = $("#convoLog");
    const statusPill = $("#statusPill");
    const btnEnable = $("#btnEnable");
    const btnStop = $("#btnStop");

    function setStatus(text){ statusPill.textContent = `Status: ${text}`; }
    function logLine(label, text, color){
      const line = document.createElement("div");
      line.style.margin = "6px 0";
      line.style.color = color || "#ddd";
      line.textContent = `${label}: ${text}`;
      convo.appendChild(line);
      convo.scrollTop = convo.scrollHeight;
    }
    const logSystem = (t)=>logLine("System", t, "#ff4d4d");
    const logYou    = (t)=>logLine("You", t, "#d6b56a");
    const logAI     = (t)=>logLine("AI", t, "#cfcfcf");

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition){
      logSystem("SpeechRecognition not supported on this device/browser.");
      setStatus("not supported");
      return;
    }

    let recognition = null;
    let enabled = false;
    let stopping = false;
    let isRunning = false;

    let lastFinalAt = 0;
    let lastFinalText = "";

    async function sendToAI(text){
      // Placeholder so you can confirm mic works FIRST.
      logAI(`(placeholder) heard: "${text}"`);
    }

    function buildRecognition(){
      const r = new SpeechRecognition();
      r.lang = "en-AU";
      r.continuous = true;
      r.interimResults = true;
      r.maxAlternatives = 1;

      r.onstart = () => {
        isRunning = true;
        setStatus("listening");
        logSystem("Mic is LIVE. Speak naturally.");
      };

      r.onerror = (e) => {
        const err = (e && e.error) ? e.error : "unknown";
        logSystem(`Voice error: ${err}`);
        setStatus(`error: ${err}`);
      };

      r.onend = () => {
        isRunning = false;
        if (enabled && !stopping){
          setStatus("restarting...");
          setTimeout(() => {
            try { r.start(); } catch (_) { setTimeout(()=>{ try{ r.start(); }catch(_){} }, 300); }
          }, 250);
        } else {
          setStatus("stopped");
        }
      };

      let finalBuffer = "";

      r.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++){
          const res = event.results[i];
          const txt = (res[0] && res[0].transcript) ? res[0].transcript : "";
          if (res.isFinal) finalBuffer += txt;
        }

        const finalText = finalBuffer.trim();
        if (!finalText) return;

        const now = Date.now();
        if (finalText === lastFinalText && (now - lastFinalAt) < 1200){
          finalBuffer = "";
          return;
        }

        lastFinalText = finalText;
        lastFinalAt = now;
        finalBuffer = "";

        logYou(finalText);
        sendToAI(finalText).catch(()=>logSystem("AI call failed (sendToAI)."));
      };

      return r;
    }

    function enableVoiceOnce(){
      if (enabled && isRunning){
        logSystem("Already listening.");
        return;
      }
      enabled = true;
      stopping = false;
      if (!recognition) recognition = buildRecognition();

      try {
        recognition.start();
        logSystem("Voice enabled. Hands-free loop is ON.");
      } catch (_) {
        logSystem("Enable pressed. If nothing happens, press Stop then Enable again.");
      }
    }

    function stopVoice(){
      stopping = true;
      enabled = false;
      setStatus("stopping...");
      try { recognition && recognition.stop(); } catch (_) {}
      logSystem("Stopped.");
    }

    btnEnable.addEventListener("click", enableVoiceOnce);
    btnStop.addEventListener("click", stopVoice);

    setStatus("idle");
    logSystem("Ready. Press Enable Voice (1x).");
  })();
  </script>
</body>
</html>
