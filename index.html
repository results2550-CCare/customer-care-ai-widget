<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Customer Care AI — Hands-Free Voice</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b0b0b; color:#fff; }
    .wrap { width:min(980px, 94vw); margin:20px auto; padding:18px; border-radius:18px; background:#121212; box-shadow:0 18px 60px rgba(0,0,0,.65); }
    .top { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title { font-weight:800; font-size:20px; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }
    .btn.primary { background:#ffb020; color:#111; }
    .btn.ghost { background:#2a2a2a; color:#fff; }
    .pill { background:#232323; padding:8px 12px; border-radius:999px; font-weight:700; opacity:.95; }
    .panel { margin-top:14px; background:#0f0f0f; border:1px solid #222; border-radius:16px; padding:14px; }
    #log { height:260px; overflow:auto; background:#0b0b0b; border:1px solid #222; border-radius:12px; padding:10px; }
    .line { margin:0 0 8px 0; opacity:.95; }
    .sys { color:#ff6b6b; }
    .you { color:#9ad1ff; }
    .ai  { color:#9cffb6; }
    .hint { opacity:.8; margin-top:10px; font-size:13px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:14px; }
    .grid input, .grid textarea {
      width:100%; box-sizing:border-box;
      background:#101010; border:1px solid #2a2a2a; color:#fff;
      border-radius:12px; padding:10px 12px; outline:none;
    }
    .grid textarea { grid-column: 1 / -1; min-height:90px; resize:vertical; }
    @media (max-width:780px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Customer Care AI — Hands-Free Voice</div>
      <div class="controls">
        <button id="enableBtn" class="btn primary">Enable Voice (1x)</button>
        <button id="stopBtn" class="btn ghost">Stop</button>
        <div id="statusPill" class="pill">Status: idle</div>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:800; margin-bottom:8px;">Conversation</div>
      <div id="log" aria-live="polite"></div>
      <div class="hint">
        Goal: press Enable once → speak → it auto-sends after you stop talking → reply → goes back to listening.
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:800; margin-bottom:8px;">Lead Capture (optional)</div>
      <div class="grid">
        <input id="first" placeholder="First name" autocomplete="given-name" />
        <input id="last" placeholder="Last name" autocomplete="family-name" />
        <input id="email" placeholder="Email" autocomplete="email" />
        <input id="phone" placeholder="Phone" autocomplete="tel" />
        <textarea id="notes" placeholder="Notes"></textarea>
      </div>
      <button class="btn ghost" style="width:100%; margin-top:10px;" id="submitLead">Submit</button>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    const logEl = $("log");
    const statusPill = $("statusPill");
    function setStatus(t){ statusPill.textContent = "Status: " + t; }

    function addLine(kind, text){
      const p = document.createElement("p");
      p.className = "line " + kind;
      p.textContent = (kind === "sys" ? "System: " : kind === "you" ? "You: " : "AI: ") + text;
      logEl.appendChild(p);
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ---------- Speech Recognition (Android Chrome safe) ----------
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null;

    let enabled = false;
    let inLoop = false;        // prevents double start
    let finalText = "";
    let lastHeardAt = 0;
    let silenceTimer = null;

    const END_SILENCE_MS = 900;  // auto-send after you stop talking
    const RESTART_DELAY_MS = 250;

    function clearSilenceTimer(){
      if(silenceTimer){ clearTimeout(silenceTimer); silenceTimer = null; }
    }

    function scheduleSendAfterSilence(){
      clearSilenceTimer();
      silenceTimer = setTimeout(() => {
        // if we haven't heard anything recently, treat as end-of-utterance
        const now = Date.now();
        if(now - lastHeardAt >= END_SILENCE_MS - 50){
          stopListeningAndSend();
        }
      }, END_SILENCE_MS);
    }

    function supportsSpeech(){
      return !!SpeechRecognition;
    }

    function buildRec(){
      const r = new SpeechRecognition();
      r.lang = "en-AU";
      r.interimResults = true;
      r.continuous = true; // best chance on Android; may still behave as non-continuous.
      return r;
    }

    function startListening(){
      if(!enabled) return;
      if(!rec) rec = buildRec();
      if(inLoop) return;

      try{
        finalText = "";
        inLoop = true;
        setStatus("listening");
        addLine("sys", "Mic is LIVE. Speak naturally.");

        rec.onresult = (event) => {
          lastHeardAt = Date.now();
          scheduleSendAfterSilence();

          let interim = "";
          for(let i = event.resultIndex; i < event.results.length; i++){
            const txt = event.results[i][0].transcript;
            if(event.results[i].isFinal) finalText += (finalText ? " " : "") + txt.trim();
            else interim += txt;
          }
          // We don't print interim every time (avoids spam). We only print when sending.
        };

        rec.onerror = (e) => {
          inLoop = false;
          clearSilenceTimer();
          setStatus("error");
          addLine("sys", "Voice error: " + (e && e.error ? e.error : "unknown"));
        };

        rec.onend = () => {
          // Android sometimes ends the mic automatically. If still enabled, restart.
          clearSilenceTimer();
          inLoop = false;
          if(enabled){
            setStatus("restarting");
            setTimeout(() => {
              if(enabled) startListening();
            }, RESTART_DELAY_MS);
          } else {
            setStatus("idle");
          }
        };

        rec.start();
      } catch(err){
        inLoop = false;
        clearSilenceTimer();
        setStatus("error");
        addLine("sys", "Start failed: " + (err && err.message ? err.message : String(err)));
      }
    }

    function stopListeningHard(){
      enabled = false;
      clearSilenceTimer();
      try { rec && rec.stop && rec.stop(); } catch {}
      setStatus("idle");
    }

    function stopListeningAndSend(){
      // stop the mic first (prevents it capturing its own output)
      clearSilenceTimer();
      const text = (finalText || "").trim();
      finalText = "";

      // Some Android builds need stop() to finalize; we stop either way.
      try { rec && rec.stop && rec.stop(); } catch {}

      if(text){
        addLine("you", text);
        // TODO: wire to /api/chat later.
        addLine("ai", "OK — received. (Next: connect to /api/chat)");
      } else {
        addLine("sys", "No speech captured. If this repeats: check site mic permission + HTTPS + not in incognito.");
      }
    }

    // ---------- UI ----------
    $("enableBtn").addEventListener("click", async () => {
      if(!supportsSpeech()){
        addLine("sys", "SpeechRecognition not supported on this browser.");
        return;
      }
      if(enabled){
        addLine("sys", "Already enabled. If it’s stuck, press Stop then Enable once.");
        return;
      }

      // Must be user-gesture on mobile: click -> start.
      enabled = true;
      setStatus("permission/listening");
      addLine("sys", "Voice enabled. Hands-free loop is ON.");
      startListening();
    });

    $("stopBtn").addEventListener("click", () => {
      stopListeningHard();
      addLine("sys", "Stopped.");
    });

    $("submitLead").addEventListener("click", () => {
      const payload = {
        first: $("first").value.trim(),
        last: $("last").value.trim(),
        email: $("email").value.trim(),
        phone: $("phone").value.trim(),
        notes: $("notes").value.trim(),
      };
      addLine("sys", "Lead saved locally (demo): " + JSON.stringify(payload));
    });

    // Initial
    setStatus("idle");
    addLine("sys", "Tap Enable Voice once. Don’t tap repeatedly.");
  </script>
</body>
</html> 
