<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b0b0f" />
  <title>Customer Care AI — Demo</title>

  <style>
    :root{
      --bg-overlay: 0.28;
      --panel-bg: rgba(15,17,23,0.78);
      --panel-border: rgba(255,255,255,0.16);
      --text: #eaeaf2;
      --muted: rgba(234,234,242,0.78);
      --accent: rgba(255,165,0,0.22);
      --accent-border: rgba(255,165,0,0.42);
      --glass: rgba(255,255,255,0.08);
      --glass-2: rgba(255,255,255,0.12);
      --shadow: rgba(0,0,0,0.45);
      --card: rgba(255,255,255,0.07);
      --card-border: rgba(255,255,255,0.14);
      --ok: rgba(60, 210, 120, 0.22);
      --warn: rgba(255, 165, 0, 0.24);
      --danger: rgba(255, 80, 80, 0.22);
      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 14px;
      --radius-sm: 12px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--text);
      background: #0b0b0f;
      overflow-x:hidden;
    }

    /* --- Background Layers --- */
    #bg-layer{
      position: fixed;
      inset: 0;
      z-index: -3;
      overflow:hidden;
      background: #0b0b0f;
    }

    #bg-video, #bg-image{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scale(1.03);
      filter: saturate(1.05) contrast(1.02);
      opacity: 1;
    }

    /* slow, premium motion (no annoying loop feel) */
    @keyframes bgSlowZoom {
      0%   { transform: scale(1.03) translate3d(0,0,0); }
      50%  { transform: scale(1.07) translate3d(-0.7%, -0.4%, 0); }
      100% { transform: scale(1.03) translate3d(0,0,0); }
    }

    .bg-animate{
      animation: bgSlowZoom 42s ease-in-out infinite;
    }

    #bg-gradient{
      position:absolute;
      inset:0;
      background: linear-gradient(135deg, #eef8ff 0%, #ffffff 35%, #dfefff 100%);
      opacity: 1;
    }

    #overlay-layer{
      position: fixed;
      inset: 0;
      z-index: -2;
      background:
        radial-gradient(900px 500px at 50% 35%, rgba(255,255,255,0.20), rgba(255,255,255,0) 65%),
        radial-gradient(1000px 600px at 60% 70%, rgba(110,180,255,0.12), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(10,10,16,var(--bg-overlay)), rgba(10,10,16,0.70));
      backdrop-filter: blur(0px);
    }

    /* subtle “breathing” to feel alive */
    @keyframes overlayBreathe{
      0% { opacity: 0.92; }
      50%{ opacity: 1.0; }
      100%{ opacity: 0.92; }
    }
    #overlay-layer{
      animation: overlayBreathe 28s ease-in-out infinite;
    }

    /* --- Layout --- */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 30;
      padding: 14px 16px;
      backdrop-filter: blur(10px);
      background: rgba(10,10,16,0.38);
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .topbar .row{
      width: min(1180px, 100%);
      margin: 0 auto;
      display:flex;
      gap: 12px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .brand .mark{
      width: 34px; height: 34px; border-radius: 12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25), rgba(255,255,255,0.05)),
                  linear-gradient(135deg, rgba(255,165,0,0.28), rgba(110,180,255,0.20));
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: 0 10px 30px rgba(0,0,0,0.28);
    }
    .brand .txt{
      display:flex; flex-direction: column;
      line-height: 1.1;
    }
    .brand .txt b{ font-size: 14px; letter-spacing: 0.2px; }
    .brand .txt span{ font-size: 12px; opacity: 0.78; }

    .top-actions{
      display:flex; align-items:center; gap: 8px; flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 12px;
      line-height: 1;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(255,255,255,0.26); }
    .btn.on{
      background: var(--accent);
      border-color: var(--accent-border);
    }
    .btn.danger.on{
      background: var(--danger);
      border-color: rgba(255,80,80,0.42);
    }
    .btn.ok.on{
      background: var(--ok);
      border-color: rgba(60,210,120,0.42);
    }
    .pill{
      font-size: 12px;
      opacity: 0.86;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .main{
      width: min(1180px, 100%);
      margin: 0 auto;
      padding: 18px 16px 40px;
      display:grid;
      grid-template-columns: 1.25fr 0.85fr;
      gap: 16px;
    }
    @media (max-width: 960px){
      .main{ grid-template-columns: 1fr; }
    }

    .hero{
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(15,17,23,0.40);
      box-shadow: 0 18px 60px var(--shadow);
      overflow:hidden;
      position: relative;
      min-height: 520px;
    }

    .hero-inner{
      position: relative;
      padding: 18px;
      height: 100%;
      display:flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 16px;
    }

    .headline{
      padding: 6px 6px 0;
    }
    .headline h1{
      margin: 0 0 6px;
      font-size: 30px;
      letter-spacing: 0.2px;
    }
    .headline p{
      margin:0;
      color: var(--muted);
      line-height: 1.35;
    }

    .hint-row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      padding: 6px;
    }

    /* --- Orbit --- */
    .orbit-stage{
      position: relative;
      height: 360px;
      border-radius: var(--radius-xl);
      overflow:hidden;
      background: radial-gradient(700px 300px at 50% 45%, rgba(255,255,255,0.10), rgba(255,255,255,0) 65%);
      border: 1px solid rgba(255,255,255,0.10);
    }

    .center-core{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width: 220px;
      height: 220px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,255,255,0.22), rgba(255,255,255,0.03) 55%),
        linear-gradient(135deg, rgba(255,165,0,0.18), rgba(110,180,255,0.14));
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: 0 24px 90px rgba(0,0,0,0.45);
      display:grid;
      place-items:center;
      text-align:center;
      padding: 16px;
      user-select:none;
      pointer-events: none;
    }

    .center-core .logo{
      width: 120px; height: 120px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.20), rgba(255,255,255,0.02)),
        conic-gradient(from 180deg, rgba(255,165,0,0.32), rgba(110,180,255,0.28), rgba(255,255,255,0.10), rgba(255,165,0,0.32));
      display:grid;
      place-items:center;
      box-shadow: inset 0 0 40px rgba(0,0,0,0.20);
    }
    .center-core .logo svg{
      width: 70px; height: 70px;
      opacity: 0.92;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.25));
    }
    .center-core .name{
      margin-top: 10px;
      font-weight: 900;
      letter-spacing: 0.3px;
      font-size: 14px;
    }
    .center-core .tag{
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.78;
    }

    /* gentle float (not spin) */
    @keyframes coreFloat{
      0%{ transform: translate(-50%,-50%) translate3d(0,0,0); }
      50%{ transform: translate(-50%,-50%) translate3d(0,-6px,0); }
      100%{ transform: translate(-50%,-50%) translate3d(0,0,0); }
    }
    .center-core{ animation: coreFloat 9.5s ease-in-out infinite; }

    .orbit{
      position:absolute;
      left:50%;
      top:50%;
      width: 620px;
      height: 620px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      pointer-events: none;
    }
    @media (max-width: 640px){
      .orbit{ width: 520px; height: 520px; }
      .center-core{ width: 200px; height: 200px; }
    }

    @keyframes orbitRotate{
      from { transform: translate(-50%,-50%) rotate(0deg); }
      to   { transform: translate(-50%,-50%) rotate(360deg); }
    }

    .orbit.r1{ animation: orbitRotate 86s linear infinite; opacity: 1; }
    .orbit.r2{ animation: orbitRotate 112s linear infinite reverse; opacity: 0.96; }
    .orbit.r3{ animation: orbitRotate 140s linear infinite; opacity: 0.92; }

    .orbit-item{
      position:absolute;
      left:50%;
      top:50%;
      width: 168px;
      height: 58px;
      transform-origin: center;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content: center;
      gap: 8px;
      padding: 0 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.30);
      pointer-events: auto;
      cursor: pointer;
      user-select:none;
      transition: transform 220ms ease, border-color 220ms ease, background 220ms ease, opacity 220ms ease;
    }
    .orbit-item:hover{
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.26);
      transform: translate3d(var(--x), var(--y), 0) scale(1.04);
    }
    .orbit-item.active{
      background: var(--accent);
      border-color: var(--accent-border);
    }

    .orbit-item .ic{
      width: 28px; height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.12);
      display:grid;
      place-items:center;
      opacity: 0.95;
    }
    .orbit-item .ic svg{ width: 16px; height: 16px; opacity: 0.95; }
    .orbit-item .label{
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    /* position items using CSS variables for each */
    .pos-a{ --x: -310px; --y: -210px; transform: translate3d(var(--x), var(--y), 0); }
    .pos-b{ --x:  260px; --y: -240px; transform: translate3d(var(--x), var(--y), 0); }
    .pos-c{ --x:  360px; --y:   0px;  transform: translate3d(var(--x), var(--y), 0); }
    .pos-d{ --x:  220px; --y:  250px; transform: translate3d(var(--x), var(--y), 0); }
    .pos-e{ --x: -240px; --y:  250px; transform: translate3d(var(--x), var(--y), 0); }
    .pos-f{ --x: -360px; --y:   0px;  transform: translate3d(var(--x), var(--y), 0); }

    @media (max-width: 640px){
      .pos-a{ --x: -250px; --y: -190px; }
      .pos-b{ --x:  210px; --y: -210px; }
      .pos-c{ --x:  290px; --y:   0px;  }
      .pos-d{ --x:  190px; --y:  210px; }
      .pos-e{ --x: -200px; --y:  210px; }
      .pos-f{ --x: -290px; --y:   0px;  }
    }

    /* --- Assistant Panel --- */
    .panel{
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255,255,255,0.14);
      background: var(--panel-bg);
      box-shadow: 0 18px 60px var(--shadow);
      overflow:hidden;
      min-height: 520px;
      display:flex;
      flex-direction: column;
    }

    .panel-head{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0));
    }
    .panel-head h2{
      margin:0 0 6px;
      font-size: 14px;
      letter-spacing: 0.2px;
    }
    .panel-head .sub{
      margin:0;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .status-row{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .status{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 12px;
      opacity: 0.92;
      user-select:none;
    }
    .dot{
      width: 8px; height: 8px; border-radius: 999px;
      background: rgba(255,255,255,0.35);
    }
    .dot.on{ background: rgba(60,210,120,0.75); box-shadow: 0 0 0 4px rgba(60,210,120,0.18); }
    .dot.warn{ background: rgba(255,165,0,0.85); box-shadow: 0 0 0 4px rgba(255,165,0,0.18); }
    .dot.off{ background: rgba(255,80,80,0.75); box-shadow: 0 0 0 4px rgba(255,80,80,0.18); }

    .chat{
      padding: 12px;
      overflow:auto;
      flex: 1;
    }
    .bubble{
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      padding: 10px 10px;
      margin: 10px 0;
      font-size: 13px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .bubble.you{
      background: rgba(0,180,255,0.10);
      border-color: rgba(0,180,255,0.22);
    }

    .panel-foot{
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.10);
      display:grid;
      gap: 8px;
    }
    .row{
      display:flex;
      gap: 8px;
      align-items:center;
    }
    .input{
      flex: 1;
      height: 40px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 0 12px;
      outline: none;
      font-size: 13px;
    }
    .send{
      height: 40px;
      padding: 0 14px;
      border-radius: 14px;
      border: 1px solid var(--accent-border);
      background: var(--accent);
      color: #fff;
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
    }

    .big-controls{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .big{
      flex: 1;
      min-width: 140px;
      height: 44px;
      border-radius: 14px;
      font-size: 13px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      cursor:pointer;
    }
    .big.on{
      background: var(--ok);
      border-color: rgba(60,210,120,0.42);
    }
    .big.pause.on{
      background: var(--danger);
      border-color: rgba(255,80,80,0.42);
    }

    .mini{
      font-size: 11px;
      color: var(--muted);
      line-height: 1.25;
    }

    .quick{
      display:flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .chip{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      cursor:pointer;
    }
    .chip:hover{ border-color: rgba(255,255,255,0.22); }

    .fade{
      transition: opacity 260ms ease, transform 260ms ease;
    }
    .hidden{
      opacity: 0;
      transform: translate3d(0, 10px, 0);
      pointer-events:none;
    }
  </style>

  <script>
    /* =========================
       EDIT THESE FIRST (top of file)
       ========================= */
    const SITE_CONFIG = {
      // backgroundType: "video" | "image" | "gradient"
      backgroundType: "image",
      backgroundVideoUrl: "", // e.g. "https://yourcdn.com/ocean.mp4"
      backgroundImageUrl: "", // e.g. "https://yourcdn.com/ocean.jpg"
      backgroundGradient: "linear-gradient(135deg, #eef8ff 0%, #ffffff 35%, #dfefff 100%)",
      overlayOpacity: 0.28,       // 0.18–0.40 typical
      animateBackground: true,    // slow zoom/parallax

      // voice defaults
      handsFreeDefault: true,     // accessibility-first
      voiceOutDefault: true,      // speak responses
      autoPauseAfterDormant: false, // set true if you want mic to turn off after “no one there”
      silence: {
        greetDelayMs: 150,        // greeting timing after start
        nudge1Ms: 8000,
        nudge2Ms: 11000,
        nudge3Ms: 13000           // after this, final “I’ll stay quiet…” then dormant
      },

      // chat endpoint
      apiEndpoint: "/api/chat"
    };

    /* =========================
       INDUSTRIES (edit labels here)
       ========================= */
    const INDUSTRIES = [
      {
        id: "dental",
        name: "Dental",
        tagline: "Bookings, pain triage, pricing basics.",
        quick: ["Book an appointment", "Tooth pain (urgent)", "Prices", "Opening hours"],
        systemPrompt: "You are a calm, professional dental clinic receptionist assistant. Be brief and reassuring. No diagnosis. Ask 2–4 questions max. Offer to capture booking details (name, phone, preferred day/time, reason)."
      },
      {
        id: "auto",
        name: "Automotive",
        tagline: "Tyres, service quotes, bookings.",
        quick: ["I need tyres", "Quote 4 tyres", "Book fitment", "Service pricing"],
        systemPrompt: "You are an automotive customer-care assistant for a tyre/service shop. Be practical and concise. Ask for vehicle, tyre size, budget, preferred date. Never claim live inventory; speak in demo terms."
      },
      {
        id: "trades",
        name: "Trades",
        tagline: "Quotes, job intake, scheduling.",
        quick: ["Request a quote", "Service areas", "Urgent call-out", "What do you charge?"],
        systemPrompt: "You are a trades/handyman customer-care assistant. Gather job type, suburb, timeframe, access constraints, and whether photos are available. Offer to capture lead details. Keep it short."
      },
      {
        id: "realestate",
        name: "Real Estate",
        tagline: "Inspections, applications, FAQs.",
        quick: ["Inspection times", "Pets allowed?", "How to apply", "Bond & lease length"],
        systemPrompt: "You are a property manager assistant. Answer common rental questions. Never promise approval. Offer to capture enquiry details for follow-up."
      },
      {
        id: "hospitality",
        name: "Hospitality",
        tagline: "Bookings, packages, policies.",
        quick: ["Book a stay", "Packages", "Cancellation policy", "Local recommendations"],
        systemPrompt: "You are a hospitality bookings assistant. Gather dates, guests, preferences. Provide policy guidance in demo terms. Offer to capture a booking request."
      }
    ];
  </script>
</head>

<body>
  <div id="bg-layer">
    <div id="bg-gradient"></div>
    <video id="bg-video" muted playsinline loop></video>
    <img id="bg-image" alt="Background" />
  </div>
  <div id="overlay-layer"></div>

  <header class="topbar">
    <div class="row">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div class="txt">
          <b>Customer Care AI</b>
          <span>English demo • hands-free voice • industry presets</span>
        </div>
      </div>

      <div class="top-actions">
        <span class="pill" id="industry-pill">Industry: —</span>
        <button class="btn ok" id="btn-start">Start Voice Session</button>
        <button class="btn danger" id="btn-pause">Pause Listening</button>
        <button class="btn" id="btn-voiceout">Voice Out</button>
        <button class="btn" id="btn-clear">Clear</button>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- HERO / INDUSTRY SELECTOR -->
    <section class="hero">
      <div class="hero-inner">
        <div class="headline">
          <h1>Talk to a website like a phone call.</h1>
          <p>
            Pick an industry. The assistant switches tone, prompts, and demo behavior.
            Built for accessibility: once you start, it can listen/speak without repeated tapping.
          </p>
        </div>

        <div class="orbit-stage">
          <div class="center-core">
            <div>
              <div class="logo" aria-hidden="true">
                <svg viewBox="0 0 64 64" fill="none">
                  <path d="M32 8c10.5 0 19 8.5 19 19 0 9.6-7.1 17.6-16.4 18.8V56h-5.2V45.8C20.1 44.6 13 36.6 13 27 13 16.5 21.5 8 32 8Z" stroke="rgba(255,255,255,0.86)" stroke-width="2.2" />
                  <path d="M24 28c0-4.4 3.6-8 8-8s8 3.6 8 8" stroke="rgba(255,255,255,0.72)" stroke-width="2.2" stroke-linecap="round"/>
                  <path d="M22 36c2.5 2.7 6 4.3 10 4.3S39.5 38.7 42 36" stroke="rgba(255,255,255,0.62)" stroke-width="2.2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="name">Customer Care AI</div>
              <div class="tag">Select an industry to begin</div>
            </div>
          </div>

          <div class="orbit r1" id="orbit-1"></div>
          <div class="orbit r2" id="orbit-2"></div>
          <div class="orbit r3" id="orbit-3"></div>
        </div>

        <div class="hint-row">
          <span class="pill">No annoying loops</span>
          <span class="pill">3 nudges then quiet</span>
          <span class="pill">Voice In + Voice Out</span>
          <span class="pill">One-tap start</span>
        </div>
      </div>
    </section>

    <!-- ASSISTANT -->
    <aside class="panel">
      <div class="panel-head">
        <h2 id="panel-title">Assistant</h2>
        <p class="sub" id="panel-sub">Choose an industry. Then press <b>Start Voice Session</b> (top-right) once.</p>

        <div class="status-row">
          <span class="status"><span class="dot" id="dot-mic"></span>Mic</span>
          <span class="status"><span class="dot" id="dot-tts"></span>Voice Out</span>
          <span class="status"><span class="dot warn" id="dot-hf"></span>Hands-free</span>
          <span class="status"><span class="dot" id="dot-net"></span>Server</span>
        </div>
      </div>

      <div class="chat" id="chat" aria-live="polite"></div>

      <div class="panel-foot">
        <div class="big-controls">
          <button class="big on" id="big-start">Start Listening</button>
          <button class="big pause" id="big-pause">Pause</button>
        </div>

        <div class="row">
          <input class="input" id="text" placeholder="Type here (optional)..." />
          <button class="send" id="send">Send</button>
        </div>

        <div class="quick" id="quick"></div>

        <div class="mini">
          If voice doesn’t start: use Chrome/Edge, allow microphone permission, then press Start again.<br/>
          This demo calls <code>/api/chat</code> and speaks replies (Voice Out).
        </div>
      </div>
    </aside>
  </main>

  <script>
    // ---------- Background init ----------
    (function initBackground(){
      document.documentElement.style.setProperty("--bg-overlay", String(SITE_CONFIG.overlayOpacity ?? 0.28));

      const bgGradient = document.getElementById("bg-gradient");
      const bgVideo = document.getElementById("bg-video");
      const bgImage = document.getElementById("bg-image");

      bgGradient.style.display = "none";
      bgVideo.style.display = "none";
      bgImage.style.display = "none";

      const animate = !!SITE_CONFIG.animateBackground;
      const setAnim = (el) => {
        el.classList.remove("bg-animate");
        if (animate) el.classList.add("bg-animate");
      };

      if (SITE_CONFIG.backgroundType === "video" && SITE_CONFIG.backgroundVideoUrl) {
        bgVideo.src = SITE_CONFIG.backgroundVideoUrl;
        bgVideo.style.display = "block";
        setAnim(bgVideo);
        bgVideo.play().catch(()=>{ /* mobile may block autoplay */ });
      } else if (SITE_CONFIG.backgroundType === "image" && SITE_CONFIG.backgroundImageUrl) {
        bgImage.src = SITE_CONFIG.backgroundImageUrl;
        bgImage.style.display = "block";
        setAnim(bgImage);
      } else if (SITE_CONFIG.backgroundType === "gradient") {
        bgGradient.style.display = "block";
        bgGradient.style.background = SITE_CONFIG.backgroundGradient || bgGradient.style.background;
      } else {
        // default fallback: gradient
        bgGradient.style.display = "block";
        bgGradient.style.background = SITE_CONFIG.backgroundGradient || bgGradient.style.background;
      }
    })();

    // ---------- UI helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const chat = $("#chat");
    const txt = $("#text");
    const quickWrap = $("#quick");
    const industryPill = $("#industry-pill");
    const panelTitle = $("#panel-title");
    const panelSub = $("#panel-sub");

    const dotMic = $("#dot-mic");
    const dotTts = $("#dot-tts");
    const dotHf = $("#dot-hf");
    const dotNet = $("#dot-net");

    const btnStart = $("#btn-start");
    const btnPause = $("#btn-pause");
    const btnVoiceOut = $("#btn-voiceout");
    const btnClear = $("#btn-clear");
    const bigStart = $("#big-start");
    const bigPause = $("#big-pause");
    const sendBtn = $("#send");

    function addBubble(who, text){
      const div = document.createElement("div");
      div.className = "bubble" + (who === "You" ? " you" : "");
      div.textContent = `${who}: ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function setNet(ok){
      dotNet.classList.toggle("on", !!ok);
    }

    // ---------- Industry orbit rendering ----------
    let selectedIndustry = INDUSTRIES[0];
    let systemPrompt = selectedIndustry.systemPrompt;

    function iconSvgFor(id){
      // simple icons (inline SVG)
      const common = 'fill="none" stroke="rgba(255,255,255,0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"';
      switch(id){
        case "dental":
          return `<svg viewBox="0 0 24 24"><path ${common} d="M8 4c-2 1-3 3-3 6 0 6 2 11 4 11 2 0 2-4 3-4s1 4 3 4c2 0 4-5 4-11 0-3-1-5-3-6" /></svg>`;
        case "auto":
          return `<svg viewBox="0 0 24 24"><path ${common} d="M3 13l2-5c.6-1.5 1.6-2 3-2h8c1.4 0 2.4.5 3 2l2 5"/><path ${common} d="M5 13h14v5H5z"/><path ${common} d="M7 18h.01M17 18h.01"/></svg>`;
        case "trades":
          return `<svg viewBox="0 0 24 24"><path ${common} d="M14 7l3 3-9 9H5v-3z"/><path ${common} d="M13 8l2-2 3 3-2 2"/></svg>`;
        case "realestate":
          return `<svg viewBox="0 0 24 24"><path ${common} d="M3 11l9-7 9 7"/><path ${common} d="M6 10v10h12V10"/></svg>`;
        case "hospitality":
          return `<svg viewBox="0 0 24 24"><path ${common} d="M4 6h16"/><path ${common} d="M6 6v12"/><path ${common} d="M18 6v12"/><path ${common} d="M6 18h12"/></svg>`;
        default:
          return `<svg viewBox="0 0 24 24"><path ${common} d="M12 3v18M3 12h18"/></svg>`;
      }
    }

    function buildOrbit(){
      const o1 = $("#orbit-1");
      const o2 = $("#orbit-2");
      const o3 = $("#orbit-3");
      o1.innerHTML = ""; o2.innerHTML = ""; o3.innerHTML = "";

      // distribute across rings and fixed positions
      const positions = ["pos-a","pos-b","pos-c","pos-d","pos-e","pos-f"];
      const rings = [o1,o2,o3];

      INDUSTRIES.forEach((ind, idx) => {
        const item = document.createElement("div");
        item.className = `orbit-item ${positions[idx % positions.length]}`;
        item.dataset.id = ind.id;
        item.innerHTML = `
          <div class="ic">${iconSvgFor(ind.id)}</div>
          <div class="label">${escapeHtml(ind.name)}</div>
        `;
        item.addEventListener("click", () => selectIndustry(ind.id));
        rings[idx % rings.length].appendChild(item);
      });

      // initial selection
      selectIndustry(selectedIndustry.id, true);
    }

    function selectIndustry(id, silent=false){
      const ind = INDUSTRIES.find(x => x.id === id) || INDUSTRIES[0];
      selectedIndustry = ind;
      systemPrompt = ind.systemPrompt;

      industryPill.textContent = `Industry: ${ind.name}`;
      panelTitle.textContent = `${ind.name} Assistant`;
      panelSub.textContent = ind.tagline || "Ready.";

      // highlight active
      document.querySelectorAll(".orbit-item").forEach(el => {
        el.classList.toggle("active", el.dataset.id === ind.id);
      });

      // quick prompts
      quickWrap.innerHTML = "";
      (ind.quick || []).forEach(q => {
        const b = document.createElement("button");
        b.className = "chip";
        b.type = "button";
        b.textContent = q;
        b.addEventListener("click", () => {
          txt.value = q;
          sendBtn.click();
        });
        quickWrap.appendChild(b);
      });

      if (!silent) {
        addBubble("Agent", `Industry set to ${ind.name}. Press “Start Voice Session” once, then talk.`);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[m]));
    }

    buildOrbit();

    // ---------- Voice (TTS) ----------
    let voiceOutEnabled = !!SITE_CONFIG.voiceOutDefault;
    btnVoiceOut.classList.toggle("on", voiceOutEnabled);
    dotTts.classList.toggle("on", voiceOutEnabled);

    function setVoiceOut(on){
      voiceOutEnabled = !!on;
      btnVoiceOut.classList.toggle("on", voiceOutEnabled);
      dotTts.classList.toggle("on", voiceOutEnabled);
    }

    btnVoiceOut.addEventListener("click", () => setVoiceOut(!voiceOutEnabled));

    function speak(text, onEnd){
      if (!voiceOutEnabled) { if (onEnd) onEnd(); return null; }
      if (!("speechSynthesis" in window)) { if (onEnd) onEnd(); return null; }

      try{
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.rate = 1.0;
        u.pitch = 1.0;
        u.volume = 1.0;
        u.onend = () => { if (onEnd) onEnd(); };
        window.speechSynthesis.speak(u);
        return u;
      } catch {
        if (onEnd) onEnd();
        return null;
      }
    }

    // ---------- Voice (SpeechRecognition) ----------
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let recognizing = false;
    let paused = false;
    let handsFree = !!SITE_CONFIG.handsFreeDefault;

    dotHf.classList.toggle("on", handsFree);

    function setMicState(state){
      // state: "on" | "warn" | "off"
      dotMic.classList.remove("on","warn","off");
      dotMic.classList.add(state);
    }

    function updatePauseUI(){
      btnPause.classList.toggle("on", paused);
      bigPause.classList.toggle("on", paused);
      btnStart.classList.toggle("on", recognizing && !paused);
      bigStart.classList.toggle("on", recognizing && !paused);
    }

    function initRecognition(){
      if (!SR) {
        addBubble("Agent", "Mic not supported in this browser. Use Chrome/Edge.");
        setMicState("off");
        return;
      }
      recognition = new SR();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = "en-AU";

      recognition.onstart = () => {
        recognizing = true;
        paused = false;
        setMicState("on");
        updatePauseUI();
        armSilenceTimers(true);
      };

      recognition.onend = () => {
        recognizing = false;
        setMicState(paused ? "off" : "warn");
        updatePauseUI();

        // If not paused and hands-free, try to restart (browser sometimes stops)
        if (!paused && handsFree) {
          setTimeout(() => {
            tryStartListening();
          }, 400);
        }
      };

      recognition.onerror = () => {
        setMicState("warn");
      };

      let finalBuf = "";
      recognition.onresult = (event) => {
        if (paused) return;
        let finalText = "";
        let interim = "";

        for (let i = event.resultIndex; i < event.results.length; i++){
          const t = event.results[i][0].transcript;
          if (event.results[i].isFinal) finalText += t;
          else interim += t;
        }

        const merged = (finalText || interim).trim();
        if (merged) {
          txt.value = merged;
          // speech detected => reset silence timers
          armSilenceTimers(false);
        }

        // If we got a final phrase, auto-send it (hands-free)
        if (finalText && finalText.trim().length > 0) {
          finalBuf += " " + finalText.trim();
          // small debounce so we don’t send multiple finals
          debounceSend(finalBuf.trim());
          finalBuf = "";
        }
      };
    }

    let sendDebounce = null;
    function debounceSend(text){
      if (sendDebounce) clearTimeout(sendDebounce);
      sendDebounce = setTimeout(() => {
        if (!text) return;
        txt.value = "";
        sendMessage(text);
      }, 280);
    }

    function tryStartListening(){
      if (!recognition) initRecognition();
      if (!recognition) return;

      try{
        if (!recognizing && !paused) recognition.start();
      } catch {
        // start() can throw if called too quickly
      }
    }

    function pauseListening(){
      paused = true;
      armSilenceTimers(false, true);
      try { if (recognition && recognizing) recognition.stop(); } catch {}
      setMicState("off");
      updatePauseUI();
      addBubble("Agent", "Listening paused. Press Start to resume.");
    }

    function resumeListening(){
      paused = false;
      updatePauseUI();
      tryStartListening();
    }

    // one-tap start controls
    btnStart.addEventListener("click", () => startSession());
    bigStart.addEventListener("click", () => startSession());
    btnPause.addEventListener("click", () => pauseListening());
    bigPause.addEventListener("click", () => pauseListening());

    function startSession(){
      // one time “gesture” to unlock audio on some browsers
      if (!selectedIndustry) selectIndustry(INDUSTRIES[0].id, true);

      // greet once on start
      const greeting = `Hi. You’re in ${selectedIndustry.name}. How can I help today?`;
      addBubble("Agent", greeting);

      setTimeout(() => {
        // start listening after greeting begins (avoid self-capture)
        speak(greeting, () => {
          if (handsFree) resumeListening();
        });
      }, SITE_CONFIG.silence.greetDelayMs || 150);
    }

    // ---------- No-loop silence nudges ----------
    let silenceTimers = [];
    let silenceState = 0; // 0=ready, 1=nudge1, 2=nudge2, 3=final, 4=dormant

    function clearSilenceTimers(){
      silenceTimers.forEach(t => clearTimeout(t));
      silenceTimers = [];
    }

    function armSilenceTimers(startFresh=true, forceDormant=false){
      if (forceDormant) {
        silenceState = 4;
        clearSilenceTimers();
        return;
      }

      if (startFresh) silenceState = 0;
      clearSilenceTimers();

      // only run nudges when mic is live and not paused and hands-free
      if (!handsFree || paused) return;

      // schedule nudges only if recognition is running (or expected to)
      const n1 = setTimeout(() => {
        if (paused) return;
        if (silenceState >= 1) return;
        silenceState = 1;
        addBubble("Agent", "I’m here whenever you’re ready.");
        speak("I’m here whenever you’re ready.");
      }, SITE_CONFIG.silence.nudge1Ms);

      const n2 = setTimeout(() => {
        if (paused) return;
        if (silenceState >= 2) return;
        silenceState = 2;

        const contextual =
          selectedIndustry.id === "dental" ? "You can say: book an appointment, tooth pain, pricing, or opening hours." :
          selectedIndustry.id === "auto" ? "You can tell me your tyre size, vehicle, and preferred date for a quote." :
          selectedIndustry.id === "trades" ? "You can describe the job, suburb, timeframe, and whether you have photos." :
          selectedIndustry.id === "realestate" ? "You can ask about inspections, applying, pets, bond, or lease length." :
          "You can ask about bookings, packages, cancellations, or local recommendations.";

        addBubble("Agent", contextual);
        speak(contextual);
      }, (SITE_CONFIG.silence.nudge1Ms + SITE_CONFIG.silence.nudge2Ms));

      const n3 = setTimeout(() => {
        if (paused) return;
        if (silenceState >= 3) return;
        silenceState = 3;

        const finalLine = "It doesn’t seem like anyone’s there. I’ll stay quiet for now. Just speak and I’ll jump back in.";
        addBubble("Agent", finalLine);

        speak(finalLine, () => {
          silenceState = 4; // dormant
          clearSilenceTimers();

          if (SITE_CONFIG.autoPauseAfterDormant) {
            pauseListening();
          }
        });
      }, (SITE_CONFIG.silence.nudge1Ms + SITE_CONFIG.silence.nudge2Ms + SITE_CONFIG.silence.nudge3Ms));

      silenceTimers.push(n1, n2, n3);
    }

    // ---------- Chat send ----------
    btnClear.addEventListener("click", () => {
      chat.innerHTML = "";
      addBubble("Agent", "Cleared. Choose an industry and press Start Voice Session.");
    });

    sendBtn.addEventListener("click", () => {
      const m = (txt.value || "").trim();
      if (!m) return;
      txt.value = "";
      sendMessage(m);
    });

    txt.addEventListener("keydown", (e) => {
      if (e.key === "Enter") sendBtn.click();
    });

    async function sendMessage(message){
      armSilenceTimers(false); // speech activity resets nudges

      addBubble("You", message);
      setNet(true);

      let reply = "Sorry — server error.";
      try{
        const payload = {
          message,
          system: systemPrompt,
          meta: { industry: selectedIndustry.name, businessName: "Customer Care AI Demo" }
        };

        const r = await fetch(SITE_CONFIG.apiEndpoint, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await r.json().catch(()=> ({}));
        reply = (data.reply || data.message || reply).trim();
        setNet(r.ok);
      } catch {
        setNet(false);
      }

      addBubble("Agent", reply);

      // Speak reply, then re-listen automatically (hands-free)
      speak(reply, () => {
        if (handsFree && !paused) {
          tryStartListening();
          armSilenceTimers(true);
        }
      });
    }

    // ---------- Boot ----------
    (function boot(){
      selectIndustry(INDUSTRIES[0].id, true);
      setVoiceOut(voiceOutEnabled);
      setNet(true);

      // show initial hint without looping
      addBubble("Agent",
        "Pick an industry. Then press “Start Voice Session” once. After that you can speak hands-free."
      );

      // init mic status
      if (!SR) setMicState("off");
      else setMicState("warn");

      updatePauseUI();
    })();
  </script>
</body>
</html>
