<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Customer Care AI — Controlled Force Demo</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

<style>
  :root{
    --bg0:#04070c;
    --bg1:#071a2e;
    --ink:rgba(255,255,255,.92);
    --muted:rgba(255,255,255,.70);
    --panel:rgba(10,16,28,.70);
    --border:rgba(255,255,255,.14);
    --accent:#ff9c1a;
    --accent2:#ffd166;
    --mint:#00ff99;
    --danger:#ff3b3b;
  }

  html,body{height:100%;margin:0;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  *{box-sizing:border-box}

  /* BACKGROUND CANVAS */
  #bg{
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 900px at 55% 35%, rgba(255,156,26,.08), transparent 60%),
      radial-gradient(1000px 800px at 35% 70%, rgba(0,255,153,.06), transparent 60%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
  }
  #bg canvas{display:block; width:100%; height:100%}

  /* VIGNETTE + GRAIN */
  #vignette{
    position:absolute; inset:0;
    background: radial-gradient(1200px 900px at 50% 40%, transparent 42%, rgba(0,0,0,.55) 75%, rgba(0,0,0,.85) 100%);
    pointer-events:none;
    mix-blend-mode:multiply;
  }
  #grain{
    position:absolute; inset:-40px;
    background-image: repeating-linear-gradient(0deg, rgba(255,255,255,.04) 0px, rgba(255,255,255,.04) 1px, transparent 2px, transparent 5px);
    opacity:.12;
    pointer-events:none;
    animation:grainMove 1.2s steps(2,end) infinite;
    mix-blend-mode:overlay;
  }
  @keyframes grainMove{
    0%{transform:translate3d(-10px,-8px,0) rotate(0.2deg)}
    50%{transform:translate3d(12px,10px,0) rotate(-0.2deg)}
    100%{transform:translate3d(-8px,12px,0) rotate(0.1deg)}
  }

  /* LAYOUT */
  #ui{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    padding:18px;
  }
  .shell{
    width:min(1050px, 96vw);
    display:grid;
    grid-template-columns: 1.1fr 1fr;
    gap:18px;
    opacity:0;
    transform:translateY(10px);
  }
  @media (max-width:900px){
    .shell{grid-template-columns:1fr;}
  }

  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:18px;
    padding:18px 18px 16px;
    box-shadow:0 18px 60px rgba(0,0,0,.45);
    backdrop-filter: blur(10px);
    position:relative;
    overflow:hidden;
  }

  h1{
    margin:0 0 8px;
    font-size: clamp(26px, 3.2vw, 46px);
    color:var(--ink);
    letter-spacing:.3px;
  }
  .sub{
    margin:0 0 14px;
    color:var(--muted);
    line-height:1.35;
    font-size: 14.5px;
  }

  .pillRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06);
    color:rgba(255,255,255,.86);
    font-size:12.5px;
    user-select:none;
  }
  .dot{
    width:8px; height:8px; border-radius:99px;
    background:var(--accent);
    box-shadow:0 0 16px rgba(255,156,26,.55);
  }

  /* BORING FORM (TARGET) */
  .formHeader{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:12px;
    color:rgba(255,255,255,.86);
    font-weight:650;
    font-size:13.5px;
  }
  .formHeader span:last-child{color:rgba(255,255,255,.55); font-weight:500;}

  #oldFormInner{
    position:relative;
    transform-origin:50% 50%;
    will-change:transform, filter, opacity;
  }
  .field{
    height:44px; border-radius:14px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.25);
    margin:10px 0;
    display:flex; align-items:center;
    padding:0 14px;
    color:rgba(255,255,255,.45);
    font-size:13.5px;
  }
  .field.big{height:110px; align-items:flex-start; padding-top:12px;}
  .btn{
    margin-top:12px;
    height:52px;
    border-radius:16px;
    background:linear-gradient(90deg, var(--accent), var(--accent2));
    display:flex; align-items:center; justify-content:center;
    font-weight:850;
    color:rgba(10,10,10,.88);
    letter-spacing:.4px;
    box-shadow:0 18px 40px rgba(255,156,26,.28);
    user-select:none;
  }

  /* CRACK + STRIKE FX (CONTROLLED FORCE) */
  #cracks{
    position:absolute; inset:-20px;
    opacity:0;
    pointer-events:none;
    background:
      radial-gradient(520px 260px at 30% 35%, rgba(0,255,153,.18), transparent 65%),
      radial-gradient(520px 320px at 70% 60%, rgba(255,156,26,.18), transparent 68%),
      repeating-linear-gradient(25deg,
        rgba(255,255,255,0) 0px,
        rgba(255,255,255,0) 18px,
        rgba(255,255,255,.18) 19px,
        rgba(255,255,255,.18) 20px,
        rgba(0,255,153,.12) 21px,
        rgba(0,255,153,.12) 22px
      );
    mix-blend-mode:screen;
    filter: blur(0.6px) saturate(1.2);
    transform:rotate(-8deg) scale(1.08);
  }
  .strike{
    position:absolute;
    width:120%;
    height:10px;
    left:-10%;
    opacity:0;
    background:linear-gradient(90deg, transparent, rgba(0,255,153,.0), rgba(0,255,153,.75), rgba(255,156,26,.45), transparent);
    filter: blur(0.35px);
    transform:skewX(-22deg);
    mix-blend-mode:screen;
  }

  /* VORTEX HOLE (PULL-IN) */
  #vortex{
    position:absolute;
    width:12px; height:12px;
    left:68%; top:54%;
    transform:translate(-50%,-50%) scale(0);
    border-radius:999px;
    background:radial-gradient(circle, rgba(0,255,153,.35), rgba(0,0,0,0) 60%);
    box-shadow:
      0 0 0 0 rgba(0,255,153,.25),
      0 0 40px 6px rgba(0,255,153,.18),
      0 0 90px 24px rgba(255,156,26,.10);
    pointer-events:none;
    opacity:0;
  }

  /* CLEAN PANEL REVEAL */
  #cleanPanel{
    position:absolute; inset:0;
    opacity:0;
    transform:scale(.985);
    display:flex;
    flex-direction:column;
    gap:12px;
    padding:16px;
    pointer-events:none;
  }
  .cleanTop{
    display:flex; align-items:center; justify-content:space-between;
    color:rgba(255,255,255,.86);
    font-weight:750; font-size:13.5px;
  }
  .badge{
    font-weight:800;
    color:rgba(0,0,0,.86);
    background:linear-gradient(90deg, rgba(0,255,153,.95), rgba(255,156,26,.92));
    padding:6px 10px;
    border-radius:999px;
    font-size:12px;
  }

  .agentBox{
    flex:1;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.22);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }

  .chatLog{
    flex:1;
    padding:14px;
    color:rgba(255,255,255,.86);
    font-size:13.5px;
    line-height:1.35;
    overflow:auto;
  }
  .msg{margin:0 0 10px;}
  .me{color:rgba(255,255,255,.92)}
  .ai{color:rgba(0,255,153,.85)}
  .sys{color:rgba(255,156,26,.82)}

  .controls{
    display:flex;
    gap:10px;
    padding:12px;
    border-top:1px solid rgba(255,255,255,.10);
    align-items:center;
  }
  .orb{
    width:40px; height:40px;
    border-radius:999px;
    background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.70), rgba(0,255,153,.25) 35%, rgba(0,0,0,.0) 70%),
               radial-gradient(circle at 60% 60%, rgba(255,156,26,.25), rgba(0,0,0,0) 60%);
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 0 22px rgba(0,255,153,.18), 0 0 34px rgba(255,156,26,.12);
    flex:0 0 auto;
    position:relative;
    overflow:hidden;
  }
  .orb::after{
    content:"";
    position:absolute; inset:-50%;
    background:conic-gradient(from 0deg, rgba(0,255,153,.0), rgba(0,255,153,.25), rgba(255,156,26,.18), rgba(0,255,153,.0));
    animation:spin 2.4s linear infinite;
    opacity:.65;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  .wave{
    flex:1;
    height:40px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    position:relative;
    overflow:hidden;
  }
  .waveBar{
    position:absolute; bottom:6px;
    width:4px;
    border-radius:99px;
    background:rgba(0,255,153,.85);
    left:10px;
    height:6px;
    opacity:.85;
    transform-origin:bottom;
  }

  .micBtn{
    height:40px;
    border-radius:12px;
    padding:0 14px;
    font-weight:850;
    letter-spacing:.2px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(255,255,255,.08);
    color:rgba(255,255,255,.90);
    cursor:pointer;
    user-select:none;
  }
  .micBtn.on{
    border-color:rgba(0,255,153,.45);
    box-shadow:0 0 0 3px rgba(0,255,153,.10);
  }

  .textRow{
    display:flex;
    gap:10px;
    padding:12px;
    border-top:1px solid rgba(255,255,255,.08);
    align-items:center;
  }
  .input{
    flex:1;
    height:42px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.22);
    color:rgba(255,255,255,.88);
    padding:0 12px;
    outline:none;
    font-size:13.5px;
  }
  .send{
    height:42px;
    border-radius:12px;
    padding:0 14px;
    font-weight:850;
    border:0;
    background:linear-gradient(90deg, var(--accent), var(--accent2));
    color:rgba(10,10,10,.88);
    cursor:pointer;
  }

  /* Tap-to-enable overlay (browser audio/mic rules) */
  #tapOverlay{
    position:absolute; inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
    opacity:0;
    pointer-events:none;
    background:radial-gradient(800px 500px at 50% 45%, rgba(0,0,0,.35), rgba(0,0,0,.65));
  }
  .tapCard{
    width:min(520px, 92vw);
    border-radius:18px;
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.14);
    padding:16px;
    text-align:center;
    color:rgba(255,255,255,.86);
    backdrop-filter: blur(10px);
    box-shadow:0 18px 60px rgba(0,0,0,.45);
  }
  .tapTitle{font-weight:900; letter-spacing:.3px; margin:0 0 8px; font-size:18px;}
  .tapDesc{margin:0 0 12px; color:rgba(255,255,255,.72); font-size:13.5px; line-height:1.35;}
  .tapBtn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:44px;
    padding:0 16px;
    border-radius:14px;
    font-weight:900;
    background:linear-gradient(90deg, rgba(0,255,153,.92), rgba(255,156,26,.92));
    border:0;
    color:rgba(0,0,0,.88);
    cursor:pointer;
  }

  /* Error ribbon */
  #err{
    position:absolute;
    left:18px; right:18px; bottom:18px;
    background:rgba(255,59,59,.10);
    border:1px solid rgba(255,59,59,.30);
    color:rgba(255,255,255,.85);
    padding:10px 12px;
    border-radius:14px;
    font-size:13px;
    opacity:0;
    pointer-events:none;
  }
</style>
</head>

<body>
  <div id="bg"><canvas id="c"></canvas></div>
  <div id="vignette"></div>
  <div id="grain"></div>

  <div id="ui">
    <div class="shell" id="shell">
      <div class="card">
        <h1>Customer Care AI</h1>
        <p class="sub">
          Controlled force. We remove outdated friction — then the calm, professional, voice-first experience takes over.
        </p>
        <div class="pillRow">
          <div class="pill"><span class="dot"></span>Voice-first capture</div>
          <div class="pill"><span class="dot"></span>No forms</div>
          <div class="pill"><span class="dot"></span>Fast conversion</div>
          <div class="pill"><span class="dot"></span>Works on any site</div>
        </div>
        <p class="sub" style="margin-top:14px">
          Demo mode: speak naturally. It will ask for details, confirm them, and reply out loud.
        </p>
      </div>

      <div class="card" id="oldFormCard">
        <div class="formHeader">
          <span>Standard Website Form</span>
          <span>Old-school friction</span>
        </div>

        <div id="cracks"></div>
        <div class="strike" id="st1" style="top:22%"></div>
        <div class="strike" id="st2" style="top:46%"></div>
        <div class="strike" id="st3" style="top:69%"></div>
        <div id="vortex"></div>

        <div id="oldFormInner">
          <div class="field">First name</div>
          <div class="field">Last name</div>
          <div class="field">Email address</div>
          <div class="field">Phone number</div>
          <div class="field big">Message</div>
          <div class="btn">Submit</div>
        </div>

        <div id="cleanPanel">
          <div class="cleanTop">
            <span>Customer Care AI Agent</span>
            <span class="badge">VOICE READY</span>
          </div>

          <div class="agentBox">
            <div class="chatLog" id="log"></div>

            <div class="controls">
              <div class="orb" id="orb" title="Agent status"></div>
              <div class="wave" id="wave"></div>
              <button class="micBtn" id="micBtn">Mic: OFF</button>
            </div>

            <div class="textRow">
              <input class="input" id="textIn" placeholder="Fallback: type here if needed…" />
              <button class="send" id="sendBtn">Send</button>
            </div>
          </div>

          <div id="tapOverlay">
            <div class="tapCard">
              <p class="tapTitle">Enable Hands-Free Voice</p>
              <p class="tapDesc">
                Browsers require one tap to enable microphone + speech output.
                After this, you can speak normally.
              </p>
              <button class="tapBtn" id="tapBtn">Tap to Start Voice</button>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div id="err"></div>

<script>
/* ---------------------------
   Premium moving background (canvas)
   - "Tech ocean" sinus waves
   - floating particles
--------------------------- */
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha:true });
let W=0,H=0,dpr=1;

function resize(){
  dpr = Math.min(2, window.devicePixelRatio || 1);
  W = canvas.width = Math.floor(window.innerWidth * dpr);
  H = canvas.height = Math.floor(window.innerHeight * dpr);
  canvas.style.width = window.innerWidth + "px";
  canvas.style.height = window.innerHeight + "px";
  ctx.setTransform(1,0,0,1,0,0);
}
window.addEventListener('resize', resize);
resize();

const particles = Array.from({length: 140}, () => ({
  x: Math.random()*W,
  y: Math.random()*H,
  r: (0.6 + Math.random()*1.8)*dpr,
  vx: (-0.25 + Math.random()*0.5)*dpr,
  vy: (-0.15 + Math.random()*0.3)*dpr,
  a: 0.10 + Math.random()*0.22,
  hue: Math.random() < 0.7 ? "0,255,153" : "255,156,26"
}));

let t0 = performance.now();

function draw(){
  const t = (performance.now()-t0)/1000;

  // subtle clear with trails
  ctx.fillStyle = "rgba(0,0,0,0.22)";
  ctx.fillRect(0,0,W,H);

  // "ocean" bands
  for(let i=0;i<6;i++){
    const yBase = H*(0.55 + i*0.07);
    ctx.beginPath();
    for(let x=0;x<=W;x+=14*dpr){
      const y = yBase
        + Math.sin(x/(140*dpr) + t*0.9 + i)* (14*dpr)
        + Math.cos(x/(240*dpr) + t*0.55)* (10*dpr);
      ctx.lineTo(x,y);
    }
    ctx.lineTo(W, H);
    ctx.lineTo(0, H);
    ctx.closePath();
    ctx.fillStyle = i%2===0 ? "rgba(0,255,153,0.018)" : "rgba(255,156,26,0.012)";
    ctx.fill();
  }

  // particles
  for(const p of particles){
    p.x += p.vx; p.y += p.vy;
    if(p.x < -50*dpr) p.x = W+50*dpr;
    if(p.x > W+50*dpr) p.x = -50*dpr;
    if(p.y < -50*dpr) p.y = H+50*dpr;
    if(p.y > H+50*dpr) p.y = -50*dpr;

    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle = `rgba(${p.hue},${p.a})`;
    ctx.fill();
  }

  requestAnimationFrame(draw);
}
ctx.fillStyle="rgba(0,0,0,1)"; ctx.fillRect(0,0,W,H);
requestAnimationFrame(draw);

/* ---------------------------
   Debris system for "form collapse"
--------------------------- */
const debris = [];
let debrisActive = false;
function spawnDebris(cx,cy, count){
  for(let i=0;i<count;i++){
    debris.push({
      x: cx + (Math.random()-0.5)*240*dpr,
      y: cy + (Math.random()-0.5)*160*dpr,
      vx: (Math.random()-0.5)*7*dpr,
      vy: (-0.2 - Math.random()*4.8)*dpr,
      g: (0.22 + Math.random()*0.26)*dpr,
      s: (2 + Math.random()*5)*dpr,
      a: 0.22 + Math.random()*0.35,
      hue: Math.random()<0.6 ? "0,255,153" : "255,156,26",
      life: 0.8 + Math.random()*1.4
    });
  }
}
function drawDebris(dt){
  if(!debrisActive) return;
  for(let i=debris.length-1;i>=0;i--){
    const d = debris[i];
    d.life -= dt;
    d.vy += d.g;
    d.x += d.vx;
    d.y += d.vy;

    // pull toward vortex (if any)
    if(vortexPull.active){
      const dx = vortexPull.x - d.x;
      const dy = vortexPull.y - d.y;
      const dist = Math.max(40*dpr, Math.hypot(dx,dy));
      const pull = (0.9 * dpr) / dist;
      d.vx += dx * pull * 0.02;
      d.vy += dy * pull * 0.02;
    }

    if(d.life <= 0){ debris.splice(i,1); continue; }

    ctx.beginPath();
    ctx.rect(d.x, d.y, d.s, d.s*0.5);
    ctx.fillStyle = `rgba(${d.hue},${Math.max(0,d.a*(d.life/1.4))})`;
    ctx.fill();
  }
  if(debris.length===0) debrisActive=false;
}

let lastDebrisT = performance.now();
(function debrisLoop(){
  const now = performance.now();
  const dt = (now - lastDebrisT)/1000;
  lastDebrisT = now;
  drawDebris(dt);
  requestAnimationFrame(debrisLoop);
})();

/* ---------------------------
   Controlled Force Cinematic
--------------------------- */
const shell = document.getElementById("shell");
const cracks = document.getElementById("cracks");
const st1 = document.getElementById("st1");
const st2 = document.getElementById("st2");
const st3 = document.getElementById("st3");
const oldFormInner = document.getElementById("oldFormInner");
const cleanPanel = document.getElementById("cleanPanel");
const tapOverlay = document.getElementById("tapOverlay");
const vortex = document.getElementById("vortex");
const err = document.getElementById("err");

const vortexPull = { active:false, x:0, y:0 };

function showErr(msg){
  err.textContent = msg;
  err.style.opacity = 1;
  setTimeout(()=>{ err.style.opacity = 0; }, 4800);
}

// entrance
gsap.to(shell, {opacity:1, y:0, duration:1.1, ease:"power3.out", delay:0.2});

function runCinematic(){
  const card = document.getElementById("oldFormCard");
  const r = card.getBoundingClientRect();
  const cx = (r.left + r.width*0.68) * dpr;
  const cy = (r.top + r.height*0.54) * dpr;

  gsap.set(vortex, { left:"68%", top:"54%" });

  const tl = gsap.timeline({ delay: 2.0 });

  // micro tension: tiny jitter, like the form is "about to be removed"
  tl.to(oldFormInner, { filter:"brightness(1.06)", duration:0.4, ease:"power1.out" }, 0)
    .to(oldFormInner, { x:2, y:1, duration:0.06, yoyo:true, repeat:10, ease:"none" }, 0.35);

  // cracks appear
  tl.to(cracks, { opacity:1, duration:0.35, ease:"power2.out" }, 0.55);

  // 3 controlled strikes (not chaos)
  const strike = (el, at) => {
    tl.to(el, { opacity:1, duration:0.07, ease:"none" }, at)
      .to(el, { opacity:0, duration:0.20, ease:"power2.in" }, at+0.08);
  };
  strike(st1, 0.85);
  strike(st2, 1.20);
  strike(st3, 1.55);

  // debris burst each strike
  tl.call(()=>{ debrisActive=true; spawnDebris(cx,cy, 90); }, null, 0.86);
  tl.call(()=>{ debrisActive=true; spawnDebris(cx,cy, 120); }, null, 1.21);
  tl.call(()=>{ debrisActive=true; spawnDebris(cx,cy, 160); }, null, 1.56);

  // vortex opens
  tl.to(vortex, { opacity:1, scale:14, duration:0.75, ease:"power3.out" }, 1.65)
    .to(vortex, { boxShadow:"0 0 0 28px rgba(0,255,153,.12), 0 0 60px 10px rgba(0,255,153,.16), 0 0 120px 38px rgba(255,156,26,.10)", duration:0.75, ease:"power2.out" }, 1.65);

  // pull-in starts (controlled)
  tl.call(()=>{
    vortexPull.active = true;
    vortexPull.x = cx;
    vortexPull.y = cy;
  }, null, 1.75);

  // form collapses inward (the "force" moment)
  tl.to(oldFormInner, {
    duration:1.35,
    ease:"power4.in",
    scale:0.18,
    rotation:-16,
    x: r.width*0.20,
    y: r.height*0.10,
    opacity:0,
    filter:"blur(1.4px) brightness(1.15)"
  }, 1.80);

  // settle: cracks fade, vortex shrinks to calm
  tl.to(cracks, { opacity:0, duration:0.9, ease:"power2.inOut" }, 2.35)
    .to(vortex, { scale:1.8, opacity:0.85, duration:0.9, ease:"power2.inOut" }, 2.45);

  // reveal clean panel
  tl.to(cleanPanel, { opacity:1, scale:1.0, duration:0.9, ease:"power3.out" }, 2.55)
    .to(vortex, { opacity:0, duration:0.75, ease:"power2.in" }, 3.05);

  tl.call(()=>{
    vortexPull.active = false;
    tapOverlay.style.pointerEvents = "auto";
    tapOverlay.style.opacity = 1;
  }, null, 3.10);
}

runCinematic();

/* ---------------------------
   Voice + Chat (hands-free after 1 tap)
   Uses /api/chat (server-side key)
--------------------------- */
const log = document.getElementById("log");
const micBtn = document.getElementById("micBtn");
const tapBtn = document.getElementById("tapBtn");
const textIn = document.getElementById("textIn");
const sendBtn = document.getElementById("sendBtn");
const wave = document.getElementById("wave");
const orb = document.getElementById("orb");

function addMsg(role, text){
  const p = document.createElement("p");
  p.className = "msg " + (role === "user" ? "me" : role === "assistant" ? "ai" : "sys");
  p.textContent = (role === "user" ? "You: " : role === "assistant" ? "AI: " : "") + text;
  log.appendChild(p);
  log.scrollTop = log.scrollHeight;
}

function setMicUI(on){
  micBtn.classList.toggle("on", on);
  micBtn.textContent = on ? "Mic: ON" : "Mic: OFF";
  orb.style.boxShadow = on ? "0 0 28px rgba(0,255,153,.22), 0 0 40px rgba(255,156,26,.14)" : "0 0 22px rgba(0,255,153,.18), 0 0 34px rgba(255,156,26,.12)";
}

function speak(text){
  // speech synthesis can be blocked until a user gesture; tapBtn provides that.
  if(!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 1.02;
  u.pitch = 0.98;
  u.volume = 1.0;
  window.speechSynthesis.speak(u);
}

let recognition = null;
let listening = false;
let waveBars = [];

function buildWave(){
  wave.innerHTML = "";
  waveBars = [];
  const n = 26;
  for(let i=0;i<n;i++){
    const b = document.createElement("div");
    b.className = "waveBar";
    b.style.left = (10 + i* ( (wave.clientWidth-20) / n )) + "px";
    b.style.height = "6px";
    wave.appendChild(b);
    waveBars.push(b);
  }
}
window.addEventListener("resize", buildWave);
buildWave();

function animateWave(level){
  const base = 6;
  for(let i=0;i<waveBars.length;i++){
    const wobble = Math.sin((performance.now()/180) + i*0.45) * 0.5 + 0.5;
    const h = base + (level*24*wobble);
    waveBars[i].style.height = Math.max(6, h) + "px";
    waveBars[i].style.opacity = 0.55 + level*0.35;
  }
}

let waveLevel = 0;
(function waveLoop(){
  // decay
  waveLevel *= 0.88;
  animateWave(waveLevel);
  requestAnimationFrame(waveLoop);
})();

function initRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    addMsg("system", "SpeechRecognition not supported in this browser. Use the text box.");
    return null;
  }
  const r = new SR();
  r.lang = "en-AU";
  r.interimResults = true;
  r.continuous = true;
  return r;
}

const systemPrompt =
  "You are Customer Care AI, a calm, professional voice-first website assistant. " +
  "Goal: capture lead details without forms. Ask ONE question at a time. " +
  "Start by asking the user's name, then phone, then email, then a short description of what they need. " +
  "Confirm captured details in a single confirmation message before finishing. " +
  "Keep responses concise, confident, and friendly.";

let messages = [
  { role:"system", content: systemPrompt }
];

async function askAI(userText){
  messages.push({ role:"user", content: userText });
  addMsg("user", userText);

  // show thinking
  addMsg("assistant", "…");
  const thinkingNode = log.lastChild;

  try{
    const resp = await fetch("/api/chat", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ messages })
    });

    const data = await resp.json();
    if(!resp.ok){
      thinkingNode.textContent = "AI: " + (data?.error || "Server error");
      showErr(data?.error || "Server error from /api/chat");
      return;
    }

    const text = (data?.text || "").trim();
    thinkingNode.textContent = "AI: " + text;
    messages.push({ role:"assistant", content: text });
    speak(text);

  }catch(e){
    thinkingNode.textContent = "AI: Network error";
    showErr("Network error calling /api/chat");
  }
}

function startListening(){
  if(!recognition){
    recognition = initRecognition();
    if(!recognition) return;
  }
  if(listening) return;

  let finalBuffer = "";
  recognition.onresult = (ev) => {
    waveLevel = Math.min(1, waveLevel + 0.18);

    let interim = "";
    for(let i=ev.resultIndex; i<ev.results.length; i++){
      const chunk = ev.results[i][0].transcript;
      if(ev.results[i].isFinal) finalBuffer += chunk + " ";
      else interim += chunk;
    }

    // If we have a final sentence chunk, send it
    const trimmed = finalBuffer.trim();
    if(trimmed.length > 0){
      // simple heuristic: only send when user pauses (final result)
      finalBuffer = "";
      askAI(trimmed);
    }
  };

  recognition.onerror = (e) => {
    setMicUI(false);
    listening = false;
    showErr("Mic error: " + (e?.error || "unknown"));
  };

  recognition.onend = () => {
    if(listening){
      // Chrome sometimes ends; restart to stay hands-free
      try{ recognition.start(); }catch(_){}
    }
  };

  try{
    recognition.start();
    listening = true;
    setMicUI(true);
  }catch(e){
    showErr("Could not start mic. Try again.");
  }
}

function stopListening(){
  listening = false;
  setMicUI(false);
  try{ recognition && recognition.stop(); }catch(_){}
}

// Mic toggle
micBtn.addEventListener("click", () => {
  if(!listening) startListening();
  else stopListening();
});

// Tap-to-enable (required by browser policies)
tapBtn.addEventListener("click", async () => {
  tapOverlay.style.opacity = 0;
  tapOverlay.style.pointerEvents = "none";

  // prime speech + mic permissions path
  addMsg("system", "Voice enabled. Say: “Hi” to begin.");
  speak("Voice enabled. Say hi to begin.");

  // Auto start mic
  startListening();
});

// Text fallback
sendBtn.addEventListener("click", () => {
  const v = (textIn.value || "").trim();
  if(!v) return;
  textIn.value = "";
  askAI(v);
});
textIn.addEventListener("keydown", (e) => {
  if(e.key === "Enter"){
    e.preventDefault();
    sendBtn.click();
  }
});

// Seed initial UI message
addMsg("assistant", "I can replace forms with conversation. Tap to enable voice, then just speak.");
</script>
</body>
</html>
